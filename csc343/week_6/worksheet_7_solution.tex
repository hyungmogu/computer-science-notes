\documentclass[12pt]{article}
\usepackage[margin=2.5cm]{geometry}
\usepackage{enumerate}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{mdframed}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{adjustbox}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage[utf]{kotex}
\usepackage{hyperref}
\usepackage{accents}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=1
}

\lstset{style=mystyle}

\pagestyle{fancy}
\renewcommand{\headrulewidth}{0.4pt}
\lhead{CSC 343}
\rhead{Worksheet 7 Solution}

\begin{document}
\title{CSC343 Worksheet 7 Solution}
\maketitle

\bigskip

\begin{enumerate}[1.]
    \item

    \begin{enumerate}[a)]
        \item
    \begin{lstlisting}[language=c]
    void askUserForPrice() {
        EXEC SQL BEGIN DECLARE SECTION;
            int model;
            float speed;
            int ram;
            int hd;
            float price;
            char maker;
            float targetPrice;

            float minDiff;
            int modelSol;
            float speedSol;
            char makerSol;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL DECLARE execCursor CURSOR FOR
            SELECT * FROM Product NATURAL JOIN PC

        EXEC SQL OPEN execCursor;

        printf("Enter target price:");
        scanf("%f", &targetPrice);

        while(1) {
            EXEC SQL FETCH FROM execCursor INTO :model,
                :speed, :ram, :hd, :price, :maker;

            if (NO_MORE_TUPLES) break;

            if (abs(price - targetPrice) >= minDiff) {
                continue;
            }

            minDiff = abs(price - targetPrice);
            modelSol = model;
            speedSol = speed;
            makerSol = maker;
        }

        EXEC SQL CLOSE execCursor;

        printf("maker=%c, model=%d, speed=%.2f\n", makerSol, modelSol, speedSol);

    }
    \end{lstlisting}

        \bigskip

        \underline{\textbf{Notes:}}

        \bigskip

        \begin{itemize}
            \item EXEC SQL
            \begin{itemize}
                \item Allows to use SQL statements within a host-language program
            \end{itemize}
            \item The DECLARE Section
            \begin{itemize}
                \item is used to declare shared variables
                \item \textbf{Syntax:}

                EXEC SQL BEGIN DECLARE SECTION;

                ... // Variable declarations in any language

                EXEC SQL END DECLARE SECTION;

                \bigskip

                \underline{\textbf{Example:}}

                \bigskip

        \begin{lstlisting}[language=SQL]
        void getStudio() {
            EXEC SQL BEGIN DECLARE SECTION;
                char studioName[50], studioAddr[256]; // <- c variables
                char SQLSTATE[6];
            EXEC SQL END DECLARE SECTION;

            EXEC SQL INSERT INTO Studio(name, address)
                    VALUES (:studioName, :studioAddr);
        }
        \end{lstlisting}
            \end{itemize}

            \item Cursors
            \begin{itemize}
                \item Is the most versatile way to connect SQL queries
                \item \textbf{Syntax:}

                EXEC SQL DECLARE $<\text{cursor name}>$ CURSOR FOR $<\text{query}>$

                \bigskip

                EXEC SQL OPEN $<\text{cursor name}>$;

                ...

                EXEC SQL CLOSE $<\text{cursor name}>$;

                \bigskip

                \underline{\textbf{Example:}}

                \bigskip

        \begin{lstlisting}[language=c]
        void getStudio() {
            EXEC SQL BEGIN DECLARE SECTION;
                char studioName[50], studioAddr[256]; // <- c variables
                char SQLSTATE[6];
            EXEC SQL END DECLARE SECTION;

            EXEC SQL INSERT INTO Studio(name, address)
                        VALUES (:studioName, :studioAddr);
        }
        \end{lstlisting}

                \bigskip

                \underline{\textbf{Example in Python:}}

                \bigskip

        \begin{lstlisting}[language=python]
        import sqlite3
        connection = sqlite3.connect("company.db")

        cursor = connection.cursor()

        staff_data = [ ("William", "Shakespeare", "m", "1961-10-25"),
                        ("Frank", "Schiller", "m", "1955-08-17"),
                        ("Jane", "Wall", "f", "1989-03-14") ]

        for p in staff_data:
            format_str = """INSERT INTO employee (staff_number, fname, lname, gender, birth_date)
            VALUES (NULL, "{first}", "{last}", "{gender}", "{birthdate}");"""

            sql_command = format_str.format(first=p[0], last=p[1], gender=p[2], birthdate = p[3])
            cursor.execute(sql_command)
        \end{lstlisting}
            \end{itemize}

            \item Fetch Statement
            \begin{itemize}
                \item fetch data from the result table one row at a time
                \item \textbf{Syntax:}

                EXEC SQL FETCH FROM $<\text{cursor name}>$ INTO $<\text{list of variables}>$

                \bigskip

                \underline{\textbf{Example:}}

                \bigskip

        \begin{lstlisting}[language=c]
        void worthRanges() {
            int i, digits, counts[15];
            EXEC SQL BEGIN DECLARE SECTION;
                int worth;
                char SQLSTATE[6];
            EXEC SQL END DECLARE SECTION;
            EXEC SQL DECLARE execCursor CURSOR FOR
                SELECT netWorth FROM MovieExec;

            EXEC SQL OPEN execCursor;
            for (i=1; i < 15; i++) counts[i] = 0;
            while(1) {
                EXEC SQL FETCH FROM execCursor INTO :worth; // fetches a row of value from movieExec and stores in worth
                if (NO_MORE_TUPLES) break;

                ...
            }
        }
        \end{lstlisting}

            \end{itemize}
        \end{itemize}

        \item

    \begin{lstlisting}[language=c]
    void findLaptops() {
        EXEC SQL BEGIN DECLARE SECTION;
            int model;
            float speed;
            int ram;
            int hd;
            int screen;
            float price;

            float minSpeed;
            int minRam;
            int minHd;
            float minPrice;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL DECLARE execCursor CURSOR FOR
            SELECT model, speed, ram, hd, screen, price, maker
            FROM Product NATURAL JOIN Laptop;

        EXEC SQL OPEN execCursor;

        printf("Enter minimum speed:");
        scanf("%f", &minSpeed);

        printf("Enter minimum ram:");
        scanf("%f", &minRam);

        printf("Enter minimum hard-drive space:");
        scanf("%f", &minHd);

        printf("Enter minimum price:");
        scanf("%f", &minPrice);

        while(1) {
            EXEC SQL FETCH FROM execCursor INTO :model,
                :speed, :ram, :hd, :screen, :price, :maker;

            if (NO_MORE_TUPLES) break;

            if (
                speed >= minSpeed &&
                ram >= minRam &&
                hd >= minHd &&
                screen >= minScreen
            ) {
                printf("model=%d, speed=%.2f, ram=%d, hd=%d, screen=%d, price=%.2f, maker=%c",
                    model, speed, ram, hd, screen, price, maker);
            }
        }

        EXEC SQL CLOSE execCursor;
    }
    \end{lstlisting}

        \item

    \begin{lstlisting}[language=c]
    void findLaptops() {
        EXEC SQL BEGIN DECLARE SECTION;
            int model;
            float speed;
            int ram;
            int hd;
            int screen;
            float price;

            float minSpeed;
            int minRam;
            int minHd;
            float minPrice;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL DECLARE execCursor CURSOR FOR
            SELECT model, speed, ram, hd, screen, price, maker
            FROM Product NATURAL JOIN Laptop;

        EXEC SQL OPEN execCursor;

        printf("Enter minimum speed:");
        scanf("%f", &minSpeed);

        printf("Enter minimum ram:");
        scanf("%f", &minRam);

        printf("Enter minimum hard-drive space:");
        scanf("%f", &minHd);

        printf("Enter minimum price:");
        scanf("%f", &minPrice);

        while(1) {
            EXEC SQL FETCH FROM execCursor INTO :model,
                :speed, :ram, :hd, :screen, :price, :maker;

            if (NO_MORE_TUPLES) break;

            if (
                speed >= minSpeed &&
                ram >= minRam &&
                hd >= minHd &&
                screen >= minScreen
            ) {
                printf("model=%d, speed=%.2f, ram=%d, hd=%d, screen=%d, price=%.2f, maker=%c",
                    model, speed, ram, hd, screen, price, maker);
            }
        }

        EXEC SQL CLOSE execCursor;
    }
    \end{lstlisting}

        \item

    \begin{lstlisting}[language=c]
    #include <stdbool.h>
    #include <string.h>
    ...
    void printSpecifications() {
        EXEC SQL BEGIN DECLARE SECTION;
            int model;
            bool color;
            char printType[50];
            float price;

            float speed;
            int ram;
            int hd;
            int screen;

            char maker;
            int productModel;
            char productType[50];

            char targetMaker;
        EXEC SQL END DECLARE SECTION;

        EXEC SQL DECLARE execCursor CURSOR FOR
            SELECT DISTINCT maker, DISTINCT productType FROM Product;

        printf("Enter manufacturer:");
        scanf("%c", &targetMaker);

        EXEC SQL OPEN execCursor;
        while (1) {
            EXEC SQL FETCH FROM execCursor INTO :maker, :productType;

            if (NO_MORE_TUPLES) break;

            if (tolower(maker) != tolower(targetMaker)) continue;

            if (strcmp(productType,'pc')) {
                EXEC SQL DECLARE pcCursor CURSOR FOR
                    SELECT speed, ram, hd, price FROM PC
                    NATURAL JOIN Product
                    WHERE type=productType;

                EXEC SQL OPEN pcCursor;
                while(1) {
                    EXEC SQL FETCH FROM pcCursor INTO :speed,
                        :ram, :hd, :price;

                    if (NO_MORE_TUPLES) break;

                    printf("model=%d, speed=%.2f, ram=%d, hd=%d, price=%.2f, maker=%c, type=%s",
                    model, speed, ram, hd, screen, price, maker, productType);
                }
                EXEC SQL CLOSE pcCursor;

            } else if (strcmp(productType, 'laptop')) {

                EXEC SQL DECLARE laptopCursor CURSOR FOR
                    SELECT speed, ram, hd, screen, price FROM Laptop
                    NATURAL JOIN Product
                    WHERE type=productType;

                EXEC SQL OPEN laptopCursor;
                while(1) {
                    EXEC SQL FETCH FROM laptopCursor INTO :speed,
                        :ram, :hd, :screen, :price;

                    if (NO_MORE_TUPLES) break;

                    printf("model=%d, speed=%.2f, ram=%d, hd=%d, screen=%d, price=%.2f, maker=%c, type=%s",
                    model, speed, ram, hd, screen, screen, price, maker, productType);
                }
                EXEC SQL CLOSE laptopCursor;


            } else if (strcmp(productType, 'printer')) {
                EXEC SQL DECLARE printerCursor CURSOR FOR
                    SELECT color, printType, price FROM Printer
                    NATURAL JOIN Product
                    WHERE type=productType;

                EXEC SQL OPEN printerCursor;
                while(1) {
                    EXEC SQL FETCH FROM printerCursor INTO :color,
                        :printType, :price;

                    if (NO_MORE_TUPLES) break;

                    printf("model=%d, color=%s, price=%.2f, maker=%c, type=%s",
                    model, color ? "true" : "false", price, maker, type);
                }
                EXEC SQL CLOSE printerCursor;
            }
        }
        EXEC SQL CLOSE execCursor;
    }
    \end{lstlisting}
        \item
        \item

    \begin{lstlisting}[language=c]
    #include <stdbool.h>
    #include <string.h>
    ...
    void insertNewPC() {
        EXEC SQL BEGIN DECLARE SECTION;
            int model;
            float speed;
            int ram;
            int hd;
            float price;
            char maker;

            int modelCount;
        EXEC SQL END DECLARE SECTION;

        printf("Enter manufacturer:\n");
        scanf("%c", &maker);

        printf("Enter model:\n");
        scanf("%d", &model);

        printf("Enter speed:\n");
        scanf("%f", &speed);

        printf("Enter ram:\n");
        scanf("%d", &ram);

        printf("Enter hd:\n");
        scanf("%d", &hd);

        printf("Enter price:\n");
        scanf("%f", &price);

        printf("Enter maker:\n");
        scanf("%c", &maker);

        EXEC SQL DECLARE execCursor CURSOR FOR
            SELECT COUNT(model) FROM (
                (SELECT model FROM Product WHERE model=:model)
                UNION
                (SELECT model FROM PC WHERE model=:model)
            );

        EXEC SQL OPEN execCursor;
            EXEC SQL FETCH FROM execCursor INTO :modelCount;

            if (modelCount != 0) {
                printf("Error. Model already exists in database.");
            } else {
                EXEC SQL INSERT INTO PC(model, speed, ram, hd, price)
                                VALUES(:model, :speed, :ram, :hd, :price);

                EXEC SQL INSERT INTO Product(model, maker, type)
                                VALUES(:model, :maker, "pc")
            }


        EXEC SQL CLOSE execCursor;
    }
    \end{lstlisting}

    \end{enumerate}

    \item
\end{enumerate}

\end{document}